-- SQL for table: EDW_NCARD_CARDINF
/* TRANSFORM_DATA */

-- 異動方式待補/待調整，以下目前為公版
/* 1. 刪除Base DATA_EXCH_DATE='#資料交換期別#' 之資料 */
DELETE FROM ${TARGET_SCHEMA}.${TARGET_TABLE} WHERE DATA_EXCH_DATE = TO_DATE('${BD_EXCH_DATE}', 'yyyy-MM-dd');

-- Trinity SQL Script
/* 2. 抽取Stage DATA_EXCH_DATE = '#資料交換期別#'之資料進行新增 */
INSERT INTO ${TARGET_SCHEMA}.${TARGET_TABLE}
(
BU,
ACCT_NBR,
PRODUCT,
CURRENCY,
CARD_NBR,
CARD_PRODUCT,
TC_CARD_NBR,
CARD_FLAG,
CARD_REL,
NEW_CUST_FLAG,
NEW_ACTIVE_FLAG,
CARDHOLDER_NBR,
CUST_NBR,
CTL_CODE,
CTL_CODE_DTE,
CTL_CODE_REASON,
EXPIR_DTE,
EXPIR_DTE_LAST,
APPLY_DTE,
APPROVE_DTE,
ISSUE_FLAG,
ISSUE_DTE,
ISSUE_REASON,
FIRST_ISSUE_DTE,
PREV_ISSUE_DTE,
OPEN_FLAG,
OPEN_DTE,
PREV_OPEN,
PREV_OPEN_DTE,
IC_CARD_FLAG,
PREV_IC_CARD_FLAG,
PIN_OFFSET,
PIN_OFFSET_MN_DT,
PREV_PIN_OFFSET,
PREV_PIN_OFFSET_MN_DT,
IC_TEMPLATE,
IC_TEMPLATE_PREV,
SERVICE_CODE,
PREV_SERVICE_CODE,
IC_SERVICE_CODE,
PREV_IC_SERVICE_CODE,
LINK_BANK_NBR,
CARD_ADDR_TYPE,
CARD_ADDR_TYPE_REISSUE,
CARD_MAIL_TYPE,
CARD_MAIL_TYPE_REISSUE,
EMBOSSING_STATUS,
EMBOSSING_DTE,
CLASS,
CARD_TERM,
EXPIR_DTE_NEXT,
ISSUE_BANK,
ADDR_BRANCH,
RISK_AMT,
SPECIAL_FLAG,
PIN_APPLY_REJECT,
PIN_APPLY_CNT,
CASH_PIN_ERROR,
CASH_PIN_DTE,
VOICE_PIN_ERROR,
VOICE_PIN_DTE,
HSRC_PIN_ERROR,
HSRC_PIN_DTE,
TEMP_CLASS,
TEMP_CLASS_START_DTE,
TEMP_CLASS_END_DTE,
SVC_PARM,
SVC_PARM_START,
SVC_PARM_END,
TXMSG_STATUS,
TXMSG_STATUS_DTE,
ATC,
PREV_ATC,
LINK_COBRAND_1_NBR,
LINK_COBRAND_2_NBR,
LINK_COBRAND_3_NBR,
USER_FEE_1_WAIVE_FLAG,
USER_FEE_1_WAIVE_DTE,
USER_FEE_2_WAIVE_FLAG,
USER_FEE_2_WAIVE_DTE,
USER_FEE_3_WAIVE_FLAG,
USER_FEE_3_WAIVE_DTE,
USER_FEE_4_WAIVE_FLAG,
USER_FEE_4_WAIVE_DTE,
USER_FEE_5_WAIVE_FLAG,
USER_FEE_5_WAIVE_DTE,
USER_FEE_6_WAIVE_FLAG,
USER_FEE_6_WAIVE_DTE,
USER_CHAR_1,
USER_CHAR_2,
USER_CHAR_3,
USER_CHAR_4,
USER_CHAR_5,
USER_CHAR_6,
USER_CHAR_7,
USER_CHAR_8,
USER_CHAR_9,
USER_CHAR_10,
USER_DTE_1,
USER_DTE_2,
USER_DTE_3,
USER_DTE_4,
USER_DTE_5,
USER_AMT_1,
USER_AMT_2,
USER_AMT_3,
USER_AMT_4,
USER_AMT_5,
POST_RESULT,
MNT_DT,
MNT_USER,
DATA_UPDATE_TIME,
DATA_EXCH_DATE
)
SELECT
BU,
ACCT_NBR,
PRODUCT,
CURRENCY,
CARD_NBR,
CARD_PRODUCT,
TC_CARD_NBR,
CARD_FLAG,
CARD_REL,
NEW_CUST_FLAG,
NEW_ACTIVE_FLAG,
CARDHOLDER_NBR,
CUST_NBR,
CTL_CODE,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(CTL_CODE_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(CTL_CODE_DTE))='0' THEN NULL ELSE CTL_CODE_DTE END) AS CTL_CODE_DTE,
CTL_CODE_REASON,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(EXPIR_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(EXPIR_DTE))='0' THEN NULL ELSE EXPIR_DTE END) AS EXPIR_DTE,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(EXPIR_DTE_LAST), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(EXPIR_DTE_LAST))='0' THEN NULL ELSE EXPIR_DTE_LAST END) AS EXPIR_DTE_LAST,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(APPLY_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(APPLY_DTE))='0' THEN NULL ELSE APPLY_DTE END) AS APPLY_DTE,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(APPROVE_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(APPROVE_DTE))='0' THEN NULL ELSE APPROVE_DTE END) AS APPROVE_DTE,
ISSUE_FLAG,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(ISSUE_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(ISSUE_DTE))='0' THEN NULL ELSE ISSUE_DTE END) AS ISSUE_DTE,
ISSUE_REASON,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(FIRST_ISSUE_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(FIRST_ISSUE_DTE))='0' THEN NULL ELSE FIRST_ISSUE_DTE END) AS FIRST_ISSUE_DTE,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(PREV_ISSUE_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(PREV_ISSUE_DTE))='0' THEN NULL ELSE PREV_ISSUE_DTE END) AS PREV_ISSUE_DTE,
OPEN_FLAG,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(OPEN_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(OPEN_DTE))='0' THEN NULL ELSE OPEN_DTE END) AS OPEN_DTE,
PREV_OPEN,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(PREV_OPEN_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(PREV_OPEN_DTE))='0' THEN NULL ELSE PREV_OPEN_DTE END) AS PREV_OPEN_DTE,
IC_CARD_FLAG,
PREV_IC_CARD_FLAG,
PIN_OFFSET,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(PIN_OFFSET_MN_DT), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(PIN_OFFSET_MN_DT))='0' THEN NULL ELSE PIN_OFFSET_MN_DT END) AS PIN_OFFSET_MN_DT,
PREV_PIN_OFFSET,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(PREV_PIN_OFFSET_MN_DT), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(PREV_PIN_OFFSET_MN_DT))='0' THEN NULL ELSE PREV_PIN_OFFSET_MN_DT END) AS PREV_PIN_OFFSET_MN_DT,
IC_TEMPLATE,
IC_TEMPLATE_PREV,
SERVICE_CODE,
PREV_SERVICE_CODE,
IC_SERVICE_CODE,
PREV_IC_SERVICE_CODE,
LINK_BANK_NBR,
CARD_ADDR_TYPE,
CARD_ADDR_TYPE_REISSUE,
CARD_MAIL_TYPE,
CARD_MAIL_TYPE_REISSUE,
EMBOSSING_STATUS,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(EMBOSSING_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(EMBOSSING_DTE))='0' THEN NULL ELSE EMBOSSING_DTE END) AS EMBOSSING_DTE,
CLASS,
CARD_TERM,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(EXPIR_DTE_NEXT), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(EXPIR_DTE_NEXT))='0' THEN NULL ELSE EXPIR_DTE_NEXT END) AS EXPIR_DTE_NEXT,
ISSUE_BANK,
ADDR_BRANCH,
RISK_AMT,
SPECIAL_FLAG,
PIN_APPLY_REJECT,
PIN_APPLY_CNT,
CASH_PIN_ERROR,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(CASH_PIN_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(CASH_PIN_DTE))='0' THEN NULL ELSE CASH_PIN_DTE END) AS CASH_PIN_DTE,
VOICE_PIN_ERROR,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(VOICE_PIN_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(VOICE_PIN_DTE))='0' THEN NULL ELSE VOICE_PIN_DTE END) AS VOICE_PIN_DTE,
HSRC_PIN_ERROR,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(HSRC_PIN_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(HSRC_PIN_DTE))='0' THEN NULL ELSE HSRC_PIN_DTE END) AS HSRC_PIN_DTE,
TEMP_CLASS,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(TEMP_CLASS_START_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(TEMP_CLASS_START_DTE))='0' THEN NULL ELSE TEMP_CLASS_START_DTE END) AS TEMP_CLASS_START_DTE,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(TEMP_CLASS_END_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(TEMP_CLASS_END_DTE))='0' THEN NULL ELSE TEMP_CLASS_END_DTE END) AS TEMP_CLASS_END_DTE,
SVC_PARM,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(SVC_PARM_START), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(SVC_PARM_START))='0' THEN NULL ELSE SVC_PARM_START END) AS SVC_PARM_START,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(SVC_PARM_END), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(SVC_PARM_END))='0' THEN NULL ELSE SVC_PARM_END END) AS SVC_PARM_END,
TXMSG_STATUS,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(TXMSG_STATUS_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(TXMSG_STATUS_DTE))='0' THEN NULL ELSE TXMSG_STATUS_DTE END) AS TXMSG_STATUS_DTE,
ATC,
PREV_ATC,
LINK_COBRAND_1_NBR,
LINK_COBRAND_2_NBR,
LINK_COBRAND_3_NBR,
USER_FEE_1_WAIVE_FLAG,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(USER_FEE_1_WAIVE_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(USER_FEE_1_WAIVE_DTE))='0' THEN NULL ELSE USER_FEE_1_WAIVE_DTE END) AS USER_FEE_1_WAIVE_DTE,
USER_FEE_2_WAIVE_FLAG,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(USER_FEE_2_WAIVE_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(USER_FEE_2_WAIVE_DTE))='0' THEN NULL ELSE USER_FEE_2_WAIVE_DTE END) AS USER_FEE_2_WAIVE_DTE,
USER_FEE_3_WAIVE_FLAG,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(USER_FEE_3_WAIVE_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(USER_FEE_3_WAIVE_DTE))='0' THEN NULL ELSE USER_FEE_3_WAIVE_DTE END) AS USER_FEE_3_WAIVE_DTE,
USER_FEE_4_WAIVE_FLAG,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(USER_FEE_4_WAIVE_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(USER_FEE_4_WAIVE_DTE))='0' THEN NULL ELSE USER_FEE_4_WAIVE_DTE END) AS USER_FEE_4_WAIVE_DTE,
USER_FEE_5_WAIVE_FLAG,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(USER_FEE_5_WAIVE_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(USER_FEE_5_WAIVE_DTE))='0' THEN NULL ELSE USER_FEE_5_WAIVE_DTE END) AS USER_FEE_5_WAIVE_DTE,
USER_FEE_6_WAIVE_FLAG,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(USER_FEE_6_WAIVE_DTE), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(USER_FEE_6_WAIVE_DTE))='0' THEN NULL ELSE USER_FEE_6_WAIVE_DTE END) AS USER_FEE_6_WAIVE_DTE,
USER_CHAR_1,
USER_CHAR_2,
USER_CHAR_3,
USER_CHAR_4,
USER_CHAR_5,
USER_CHAR_6,
USER_CHAR_7,
USER_CHAR_8,
USER_CHAR_9,
USER_CHAR_10,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(USER_DTE_1), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(USER_DTE_1))='0' THEN NULL ELSE USER_DTE_1 END) AS USER_DTE_1,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(USER_DTE_2), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(USER_DTE_2))='0' THEN NULL ELSE USER_DTE_2 END) AS USER_DTE_2,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(USER_DTE_3), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(USER_DTE_3))='0' THEN NULL ELSE USER_DTE_3 END) AS USER_DTE_3,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(USER_DTE_4), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(USER_DTE_4))='0' THEN NULL ELSE USER_DTE_4 END) AS USER_DTE_4,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(USER_DTE_5), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(USER_DTE_5))='0' THEN NULL ELSE USER_DTE_5 END) AS USER_DTE_5,
USER_AMT_1,
USER_AMT_2,
USER_AMT_3,
USER_AMT_4,
USER_AMT_5,
POST_RESULT,
SDG.UFN_NORM_DATE(CASE WHEN NVL(TRIM(MNT_DT), '')='' THEN NULL WHEN SDG.UFN_ADDATECHECK_DATE(TRIM(MNT_DT))='0' THEN NULL ELSE MNT_DT END) AS MNT_DT,
MNT_USER,
CURRENT_TIMESTAMP,
to_date('${BD_EXCH_DATE}', 'yyyy-MM-dd')
FROM ${SOURCE_TABLE_OWNER}.${SOURCE_TABLE}
WHERE DATA_EXCH_DATE = to_date('${BD_EXCH_DATE}', 'yyyy-MM-dd')
;

.export @LOAD_ROWCNT updatecnt;
